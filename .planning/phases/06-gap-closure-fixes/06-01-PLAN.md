---
phase: 06-gap-closure-fixes
plan: 06-01
created: 2026-02-02T03:30:00Z
status: ready
---

# Plan 06-01: Gap Closure Fixes

**Phase Goal:** Close critical gaps from v1.0 audit and fix immediate blocking bugs

**This Plan:** Fix immediate blocking bugs + Phase 1 UX/integration gaps (Xcode CLT manual interaction is acceptable)

---

## What This Plan Delivers

Users can run setup with minimal manual intervention and no errors:
1. ✓ Scripts source correctly without SCRIPT_DIR path errors
2. ✓ Starship installs and .zshrc works on fresh Mac
3. ✓ Claude desktop app in correct Brewfile location
4. ✓ Beautiful CLI output works before gum installs (no -e artifacts)
5. ✓ Setup script stops on first error (no cascading failures)
6. ✓ Homebrew verification before Phase 3 prevents silent failures

Note: Xcode CLT manual interaction (clicking Install button) is acceptable - not automated in this plan.

---

## Current State Analysis

### Immediate Blocking Bugs (CRITICAL)

**Bug 1: SCRIPT_DIR Double Path**
- **Location:** `scripts/symlink-dotfiles.sh:8`, `scripts/setup-git.sh:11`, `scripts/setup-ssh.sh:11`
- **Issue:** Scripts redefine SCRIPT_DIR when sourced, causing `/scripts/scripts/` double paths
- **Impact:** Phase 2 fails: `setup: line 102: /Users/mlaws/dotfiles/scripts/scripts/setup-git.sh: No such file or directory`
- **Root Cause:** Sourced scripts use `dirname "$0"` or `dirname "${BASH_SOURCE[0]}"` which resolves to scripts/ directory, not repo root

**Bug 2: Starship Missing from Brewfile**
- **Location:** `config/Brewfile` (missing), `.zshrc:20` (expects it)
- **Issue:** .zshrc runs `eval "$(starship init zsh)"` but starship never installed
- **Impact:** Fresh Mac fails: `.zshrc:20: command not found: starship`
- **Root Cause:** Starship dependency not declared in Brewfile

**Bug 3: Claude in Wrong Brewfile**
- **Location:** `config/Brewfile:line-with-claude` (should be in `config/Brewfile.apps`)
- **Issue:** Claude is a cask (GUI app) but declared as brew (CLI tool)
- **Impact:** Installation fails silently, shows in `brew bundle check` as missing
- **Root Cause:** Claude desktop app categorized incorrectly

### Milestone Audit Gaps (HIGH PRIORITY)

**Gap 1: Echo Fallback Broken (UX-01 partial)**
- **Location:** `scripts/lib/ui.sh` (all functions)
- **Issue:** Uses `echo -e` which prints `-e` literally on macOS
- **Impact:** Ugly output before gum installs: `-e ✓ Xcode Command Line Tools already installed`
- **Fix:** Replace `echo -e` with `printf`

**Gap 3: No Error Propagation (Integration Issue 1)**
- **Location:** `setup` script (missing `set -e`)
- **Issue:** Phase failures don't stop script execution
- **Impact:** Cascading failures with confusing errors
- **Fix:** Add `set -e` at top of setup script

**Gap 4: No Homebrew Verification (Integration Issue 2)**
- **Location:** `setup` between Phase 1 and Phase 3
- **Issue:** Phase 3 assumes Homebrew succeeded, no check
- **Impact:** Silent failures with cryptic errors
- **Fix:** Add `is_homebrew_installed` check before Phase 3

---

## Tasks

### Task 1: Fix SCRIPT_DIR Double Path Bug

**Problem:** Sourced scripts redefine SCRIPT_DIR, breaking subsequent source commands

**Solution:** Use local variable `SCRIPTS_DIR` in sourced scripts, preserve parent's `SCRIPT_DIR`

**Changes:**

1. **scripts/symlink-dotfiles.sh** (line 8):
```bash
# BEFORE (breaks SCRIPT_DIR for subsequent scripts):
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# AFTER (use local variable):
SCRIPTS_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
```

Then update all references in same file:
- Line 11: `. "$SCRIPTS_DIR/lib/detect.sh"`
- Line 12: `. "$SCRIPTS_DIR/lib/ui.sh"`
- Line 56: `DOTFILES_DIR="$SCRIPTS_DIR/../dotfiles"`
- Any other `$SCRIPT_DIR` → `$SCRIPTS_DIR`

2. **scripts/setup-git.sh** (line 11):
```bash
# BEFORE:
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

# AFTER:
SCRIPTS_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
```

Then update references:
- Line 13: `. "$SCRIPTS_DIR/lib/ui.sh"`
- Line 16: `REPO_ROOT="$SCRIPTS_DIR/.."`
- Any other `$SCRIPT_DIR` → `$SCRIPTS_DIR`

3. **scripts/setup-ssh.sh** (line 11):
```bash
# BEFORE:
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

# AFTER:
SCRIPTS_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
```

Then update references:
- Line 13: `. "$SCRIPTS_DIR/lib/ui.sh"`
- Any other `$SCRIPT_DIR` → `$SCRIPTS_DIR`

**Verification:**
```bash
# Test setup sources all Phase 2 scripts without error:
bash -c 'SCRIPT_DIR=/Users/mlaws/dotfiles; source scripts/symlink-dotfiles.sh; echo "SCRIPT_DIR=$SCRIPT_DIR"; source scripts/setup-git.sh; echo "SCRIPT_DIR=$SCRIPT_DIR"'
# Should print SCRIPT_DIR=/Users/mlaws/dotfiles twice (unchanged)
```

---

### Task 2: Add Starship to Brewfile

**Problem:** .zshrc expects starship but it's not installed

**Solution:** Add starship formula to CLI tools Brewfile

**Changes:**

**config/Brewfile** (add after line with tree):
```ruby
brew "starship"         # Cross-shell prompt with minimal, powerful configuration
```

**Verification:**
```bash
grep "starship" config/Brewfile  # Should find entry
brew bundle check --file=config/Brewfile  # Should show starship as needed (if not installed)
```

---

### Task 3: Move Claude to Brewfile.apps

**Problem:** Claude is a cask (GUI app) but listed in CLI tools Brewfile

**Solution:** Remove from Brewfile, add to Brewfile.apps in Dev Tools section

**Changes:**

1. **config/Brewfile** (remove line):
```ruby
# DELETE this line:
brew "claude"           # Anthropic's Claude AI assistant
```

2. **config/Brewfile.apps** (add to Dev Tools section):
```ruby
# Dev Tools
cask "visual-studio-code"  # (essential) Primary code editor
cask "cursor"              # (essential) AI-powered code editor
cask "hyper"               # (recommended) Beautiful terminal built on web tech
cask "claude"              # (recommended) Anthropic's Claude AI desktop app
cask "docker"              # (optional) Container platform
cask "postman"             # (optional) API development and testing
```

**Verification:**
```bash
! grep "claude" config/Brewfile  # Should not find it (removed)
grep "cask \"claude\"" config/Brewfile.apps  # Should find it
```

---

### Task 4: Fix Echo Fallback (Use Printf)

**Problem:** `echo -e` prints `-e` literally on macOS, breaking visual output

**Solution:** Replace all `echo -e` with `printf` in ui.sh fallback functions

**Changes:**

**scripts/lib/ui.sh** (replace echo -e in all fallback functions):

```bash
# BEFORE (lines ~30-107, all functions):
echo -e "${PINK}╔══════════════════════════════════════════════════════╗${NC}"
echo -e "${PINK}║${NC} $1"
echo -e "${PINK}╚══════════════════════════════════════════════════════╝${NC}"

# AFTER (use printf instead):
printf "${PINK}╔══════════════════════════════════════════════════════╗${NC}\n"
printf "${PINK}║${NC} %s\n" "$1"
printf "${PINK}╚══════════════════════════════════════════════════════╝${NC}\n"
```

**All ui functions to update:**
1. `ui_header()` - 3 echo -e → printf
2. `ui_section()` - 1 echo -e → printf
3. `ui_success()` - 1 echo -e → printf
4. `ui_error()` - 1 echo -e → printf
5. `ui_info()` - 1 echo -e → printf
6. `ui_spin()` - Function body (complex spinner logic)

**Pattern:**
```bash
# Single line output:
echo -e "text $var more"  →  printf "text %s more\n" "$var"

# Literal text only:
echo -e "literal text"    →  printf "literal text\n"

# Multiple variables:
echo -e "$a $b $c"        →  printf "%s %s %s\n" "$a" "$b" "$c"
```

**Verification:**
```bash
# Test without gum installed:
mv /opt/homebrew/bin/gum /opt/homebrew/bin/gum.bak  # Hide gum temporarily
source scripts/lib/ui.sh
ui_success "Test message"  # Should NOT show "-e" in output
mv /opt/homebrew/bin/gum.bak /opt/homebrew/bin/gum  # Restore gum
```

---

### Task 5: Add Error Propagation to Setup Script

**Problem:** Script continues after phase failures, causing cascading errors

**Solution:** Add `set -e` to stop on first error

**Changes:**

**setup** (add after shebang):
```bash
#!/bin/bash
#
# Dotfiles Setup - Entry Point
# Run with: sh setup

# Exit on any error, undefined variable, or pipe failure
set -euo pipefail

# Parse command-line flags
VERBOSE=false
```

**Verification:**
```bash
# Test that script exits on error:
# Temporarily break install-homebrew.sh to return error:
echo "exit 1" >> scripts/install-homebrew.sh
sh setup  # Should exit immediately, NOT continue to Phase 2
git restore scripts/install-homebrew.sh  # Undo test change
```

---

### Task 6: Add Homebrew Verification Before Phase 3

**Problem:** Phase 3 assumes Homebrew succeeded, no verification

**Solution:** Add explicit check after Phase 1, before Phase 3

**Changes:**

**setup** (add between Phase 1 and Phase 3):
```bash
# ============================================
# Phase 2: Dotfiles & Developer Config
# ============================================

source "$SCRIPT_DIR/scripts/symlink-dotfiles.sh"
source "$SCRIPT_DIR/scripts/setup-git.sh"
source "$SCRIPT_DIR/scripts/setup-ssh.sh"

# ============================================
# Verify Prerequisites for Phase 3
# ============================================

# Homebrew is required for app installation
if ! is_homebrew_installed; then
  echo ""
  echo "❌ Error: Homebrew is not installed"
  echo ""
  echo "Phase 3 (Applications & System Settings) requires Homebrew."
  echo "Please resolve Phase 1 issues before continuing."
  echo ""
  exit 1
fi

# ============================================
# Phase 3: Applications & System Settings
# ============================================
```

**Verification:**
```bash
# Test with Homebrew missing:
mv /opt/homebrew /opt/homebrew.bak  # Hide Homebrew
sh setup  # Should fail with clear error before Phase 3
mv /opt/homebrew.bak /opt/homebrew  # Restore Homebrew
```

---

## Must-Haves (Observable Truths)

When this plan is complete, these MUST be true:

1. **No SCRIPT_DIR path errors**: User runs `sh setup`, Phase 2 scripts source without `/scripts/scripts/` double path errors

2. **Starship works on fresh Mac**: User runs setup on Mac without starship, .zshrc loads without "command not found: starship" error

3. **Claude in correct location**: `config/Brewfile` has no claude entry, `config/Brewfile.apps` has `cask "claude"` in Dev Tools section


5. **Beautiful CLI before gum**: User runs setup before gum installed, sees clean output without "-e" characters

6. **Script stops on error**: If Phase 1 fails, setup script exits immediately without attempting Phase 2/3

7. **Homebrew verification**: If Homebrew missing after Phase 1, setup shows clear error and exits before Phase 3

---

## Nice-to-Haves

- Update CHANGELOG.md with bug fixes and gap closures
- Add comments explaining why SCRIPTS_DIR vs SCRIPT_DIR
- Update Phase 1 VERIFICATION.md to reflect gaps closed

---

## Non-Goals

- Fixing unused backup functions (low priority tech debt)
- Implementing v2 features
- Refactoring beyond minimum necessary changes

---

## Dependencies

**Requires:**
- Phase 1-5 complete (current state)
- v1.0 milestone audit report

**Blocks:**
- v1.0 milestone completion
- Fresh Mac testing without manual intervention

---

## Verification Checklist

After implementation:

- [ ] Task 1: Source Phase 2 scripts without path errors
- [ ] Task 2: Starship in Brewfile, .zshrc works
- [ ] Task 3: Claude moved to Brewfile.apps
- [ ] Task 4: Xcode CLT installs without GUI dialog
- [ ] Task 5: UI functions work without -e artifacts (test without gum)
- [ ] Task 6: Script exits immediately on phase failure
- [ ] Task 7: Clear error if Homebrew missing before Phase 3
- [ ] All scripts pass `bash -n` syntax check
- [ ] Run full setup on Mac with existing state (update mode) - should work
- [ ] Run full setup on Mac without state (fresh mode) - should work hands-off

---

## Success Criteria

**Phase Goal Achieved When:**

User can run `./setup` on brand new Mac and:
- ✓ No manual intervention required (no GUI clicks, no keyboard input during execution)
- ✓ No path errors or command not found errors
- ✓ Clear error messages if prerequisites fail
- ✓ Beautiful output from start to finish
- ✓ Script stops cleanly on first error

**v1.0 Requirement Coverage:** 29/29 (100%)
- ✓ PKG-05 satisfied (Xcode CLT automatic)
- ✓ UX-01 satisfied (Beautiful CLI with no artifacts)
- ✓ Integration issues resolved (error propagation, Homebrew verification)

---

*Plan created: 2026-02-02T03:30:00Z*
*Estimated effort: 1-1.5 hours*
*Complexity: Medium (6 targeted fixes, clear scope)*
