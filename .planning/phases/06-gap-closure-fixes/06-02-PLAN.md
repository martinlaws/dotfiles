---
phase: 06-gap-closure-fixes
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified: ["scripts/configure-system.sh"]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Phase 3 scripts source successfully without SCRIPT_DIR path errors"
    - "install-apps.sh executes after configure-system.sh completes"
    - "Claude desktop app installs via Homebrew"
  artifacts:
    - path: "scripts/configure-system.sh"
      provides: "System settings configuration without SCRIPT_DIR collision"
      contains: "SCRIPTS_DIR"
  key_links:
    - from: "setup"
      to: "scripts/configure-system.sh"
      via: "source on line 127"
      pattern: "source.*configure-system.sh"
    - from: "setup"
      to: "scripts/install-apps.sh"
      via: "source on line 128 using preserved SCRIPT_DIR"
      pattern: "source.*SCRIPT_DIR.*install-apps.sh"
---

<objective>
Fix SCRIPT_DIR collision in configure-system.sh that prevents install-apps.sh from running

Purpose: configure-system.sh redefines SCRIPT_DIR on line 9, corrupting the parent's exported SCRIPT_DIR and causing double path `/scripts/scripts/` on line 128 of setup script
Output: configure-system.sh uses SCRIPTS_DIR instead of SCRIPT_DIR, preserving parent's exported value
</objective>

<execution_context>
@/Users/mlaws/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mlaws/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-gap-closure-fixes/06-01-SUMMARY.md
@.planning/phases/06-gap-closure-fixes/06-UAT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix SCRIPT_DIR collision in configure-system.sh</name>
  <files>scripts/configure-system.sh</files>
  <action>
    Rename SCRIPT_DIR to SCRIPTS_DIR in configure-system.sh to match the pattern established in 06-01 for Phase 2 scripts.

    Line 9 change:
    ```bash
    # BEFORE:
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

    # AFTER:
    SCRIPTS_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    ```

    Line 12 change:
    ```bash
    # BEFORE:
    source "$SCRIPT_DIR/lib/ui.sh"

    # AFTER:
    source "$SCRIPTS_DIR/lib/ui.sh"
    ```

    This is the ONLY script that was missed in 06-01. install-apps.sh already handles this correctly by using conditional assignment: `SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "$0")/.." && pwd)}"` which preserves the parent's exported value.

    The fix follows the established pattern from 06-01 where symlink-dotfiles.sh, setup-git.sh, and setup-ssh.sh all use SCRIPTS_DIR for their local paths.
  </action>
  <verify>
    Run verification command to confirm SCRIPT_DIR is preserved:
    ```bash
    bash -c 'export SCRIPT_DIR=/Users/mlaws/dotfiles; source scripts/configure-system.sh 2>/dev/null || true; echo "SCRIPT_DIR=$SCRIPT_DIR"'
    # Should print: SCRIPT_DIR=/Users/mlaws/dotfiles (unchanged)
    ```

    Verify no remaining SCRIPT_DIR references in configure-system.sh:
    ```bash
    grep -n "SCRIPT_DIR" scripts/configure-system.sh
    # Should return no matches (only SCRIPTS_DIR should exist)
    ```
  </verify>
  <done>
    configure-system.sh uses SCRIPTS_DIR for its own path resolution, preserving the parent's exported SCRIPT_DIR. Line 128 of setup script (`source "$SCRIPT_DIR/scripts/install-apps.sh"`) now resolves correctly to `/Users/mlaws/dotfiles/scripts/install-apps.sh`.
  </done>
</task>

</tasks>

<verification>
After fix:
1. Run `./setup` on a Mac with existing state (update mode should work)
2. Or manually trace the path:
   - setup exports SCRIPT_DIR=/Users/mlaws/dotfiles
   - configure-system.sh sources, uses SCRIPTS_DIR internally
   - After configure-system.sh completes, setup's SCRIPT_DIR still = /Users/mlaws/dotfiles
   - install-apps.sh sources from correct path $SCRIPT_DIR/scripts/install-apps.sh

All 3 UAT gaps will close with this single fix since they share the same root cause.
</verification>

<success_criteria>
- [ ] configure-system.sh contains SCRIPTS_DIR instead of SCRIPT_DIR
- [ ] setup script's SCRIPT_DIR is preserved after sourcing configure-system.sh
- [ ] install-apps.sh executes without "No such file or directory" error
- [ ] Claude desktop app can install (since install-apps.sh now runs)
</success_criteria>

<output>
After completion, create `.planning/phases/06-gap-closure-fixes/06-02-SUMMARY.md`
</output>
