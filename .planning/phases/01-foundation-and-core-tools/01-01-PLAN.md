---
phase: 01-foundation-and-core-tools
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - setup
  - scripts/lib/ui.sh
  - scripts/lib/detect.sh
  - scripts/install-homebrew.sh
  - config/Brewfile
autonomous: true

must_haves:
  truths:
    - "User runs sh setup and sees beautiful welcome screen with Gum styling"
    - "Xcode Command Line Tools install automatically without manual intervention"
    - "Homebrew installs to /opt/homebrew on Apple Silicon or /usr/local on Intel"
    - "brew command is available in PATH immediately after installation"
    - "Setup is idempotent - re-running skips already-installed Homebrew and Xcode CLT"
  artifacts:
    - path: "setup"
      provides: "Entry point script"
      contains: "sh scripts/install-homebrew.sh"
    - path: "scripts/lib/ui.sh"
      provides: "Gum wrapper functions for consistent styling"
      contains: "gum style"
    - path: "scripts/lib/detect.sh"
      provides: "Architecture and state detection"
      contains: "uname -m"
    - path: "scripts/install-homebrew.sh"
      provides: "Homebrew and Xcode CLT installation with UI"
      contains: "xcode-select"
    - path: "config/Brewfile"
      provides: "CLI tools declaration"
      contains: 'brew "gum"'
  key_links:
    - from: "setup"
      to: "scripts/install-homebrew.sh"
      via: "sh source"
      pattern: "sh.*install-homebrew"
    - from: "scripts/install-homebrew.sh"
      to: "scripts/lib/ui.sh"
      via: "source import"
      pattern: "source.*lib/ui.sh"
    - from: "scripts/install-homebrew.sh"
      to: "scripts/lib/detect.sh"
      via: "source import"
      pattern: "source.*lib/detect.sh"
---

<objective>
Create project structure and implement Homebrew installation with beautiful CLI interface, including automatic Xcode Command Line Tools installation.

Purpose: Establish the foundation that all subsequent phases build upon - directory structure, reusable UI functions, Xcode CLT as a development prerequisite, and Homebrew as the package manager.

Output: Working setup entry point that installs Xcode CLT and Homebrew with progress indicators, architecture detection, and immediate PATH configuration.
</objective>

<execution_context>
@/Users/mlaws/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mlaws/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-core-tools/01-CONTEXT.md
@.planning/phases/01-foundation-and-core-tools/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create project structure and reusable libraries</name>
  <files>
    setup
    scripts/lib/ui.sh
    scripts/lib/detect.sh
    config/Brewfile
  </files>
  <action>
Create the project directory structure and foundation scripts:

1. **setup** (entry point):
   - Shebang: `#!/bin/bash` (research says use bash, not sh)
   - Parse flags with getopts: -v (verbose), -h (help)
   - Source lib/detect.sh to get SCRIPT_DIR and ARCH
   - Display welcome header using Gum (balanced emoji style per CONTEXT)
   - Call install-homebrew.sh
   - For now, just echo placeholder for "tools installation coming in next plan"
   - Run via: `sh setup` (no chmod needed per CONTEXT decision)

2. **scripts/lib/ui.sh** (Gum wrapper functions):
   - `ui_header "text"` - main section header with double border, pink (212) foreground
   - `ui_section "text"` - subsection with bold styling
   - `ui_success "text"` - green checkmark + message
   - `ui_error "text"` - red X + message
   - `ui_info "text"` - info message with optional emoji
   - `ui_spin "title" command...` - wrapper for gum spin with dot spinner
   - `ui_confirm "question"` - wrapper for gum confirm
   - Handle VERBOSE mode: when VERBOSE=true, skip spinners and show full output
   - Use foreground 212 (pink) as primary color, 196 (red) for errors, 10 (green) for success

3. **scripts/lib/detect.sh** (detection utilities):
   - Set SCRIPT_DIR using dirname approach that works when sourced
   - Detect architecture: `ARCH=$(uname -m)` -> arm64 or x86_64
   - Set BREW_PREFIX: /opt/homebrew for arm64, /usr/local for x86_64
   - `is_homebrew_installed()` - uses `command -v brew`
   - `is_xcode_clt_installed()` - uses `xcode-select -p` to check if CLT path exists
   - `is_tool_installed()` - generic check for any command
   - Export all variables and functions

4. **config/Brewfile**:
   - Phase 1 CLI tools per requirements (PKG-02):
     ```
     brew "git"
     brew "node"       # includes npm
     brew "yarn"
     brew "pnpm"
     brew "gh"
     brew "tree"
     brew "gum"
     brew "stow"
     brew "claude"
     ```
   - Add comments for each tool explaining purpose
   - Note: gum is installed early because we need it for UI, so Homebrew install must happen first without gum
   - Note: npm is bundled with node, so no separate entry needed

IMPORTANT: The setup script must work on first run when gum is NOT installed yet. Use plain echo for pre-gum output, then gum for post-Homebrew output.
  </action>
  <verify>
    - `ls -la setup scripts/lib/ui.sh scripts/lib/detect.sh config/Brewfile` shows all files exist
    - `sh setup -h` displays help text without errors
    - `bash -n setup && bash -n scripts/lib/ui.sh && bash -n scripts/lib/detect.sh` validates syntax
    - `grep -q 'brew "yarn"' config/Brewfile && grep -q 'brew "claude"' config/Brewfile` confirms required tools present
  </verify>
  <done>
    - setup entry point exists and parses -v and -h flags
    - scripts/lib/ui.sh provides Gum wrapper functions
    - scripts/lib/detect.sh detects architecture, sets BREW_PREFIX, and checks Xcode CLT status
    - config/Brewfile declares all Phase 1 CLI tools including yarn and claude
    - All scripts pass bash syntax validation
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Xcode CLT and Homebrew installation with beautiful UI</name>
  <files>
    scripts/install-homebrew.sh
    setup
  </files>
  <action>
Create the Xcode CLT and Homebrew installation script with proper UI and error handling:

1. **scripts/install-homebrew.sh**:
   - Source lib/detect.sh and lib/ui.sh at top

   **Xcode Command Line Tools Installation (BEFORE Homebrew):**
   - Check if Xcode CLT already installed using `is_xcode_clt_installed` (checks `xcode-select -p`)
     - If yes: show "Xcode Command Line Tools already installed, skipping..." with plain echo (gum not yet available)
     - If no: proceed with installation

   - Install Xcode CLT:
     - Show message: "Installing Xcode Command Line Tools..."
     - Run: `xcode-select --install`
     - IMPORTANT: This command opens a GUI dialog. To make it non-interactive, use the touch file trick:
       ```bash
       # Create temporary file that triggers CLT install
       touch /tmp/.com.apple.dt.CommandLineTools.installondemand.in-progress
       # Find and install the CLT package
       PROD=$(softwareupdate -l | grep -B 1 "Command Line Tools" | grep -E "^\*" | sed 's/^[* ]*//' | head -1)
       softwareupdate -i "$PROD" --verbose
       rm /tmp/.com.apple.dt.CommandLineTools.installondemand.in-progress
       ```
     - If the softwareupdate approach fails, fall back to `xcode-select --install` with a message asking user to complete the dialog

   - Verify installation: `xcode-select -p` should return a valid path (typically /Library/Developer/CommandLineTools)
   - If verification fails after install attempt: show error and suggest manual installation

   **Homebrew Installation (AFTER Xcode CLT):**
   - Check if Homebrew already installed using `is_homebrew_installed`
     - If yes: show "Homebrew already installed, skipping..." with ui_success
     - If no: proceed with installation

   - Pre-installation messaging (BEFORE gum is available):
     - Use plain echo with basic ANSI colors for "Installing Homebrew..."
     - Explain that sudo password may be required (per CONTEXT: prompt when needed)
     - Show which path will be used based on ARCH

   - Installation:
     - Run: `NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"`
     - Do NOT use set -e; check exit code explicitly
     - If fails: show error message, ask user if they want to retry or abort

   - Post-installation:
     - Configure PATH immediately: `eval "$($BREW_PREFIX/bin/brew shellenv)"`
     - Verify with `command -v brew`
     - Add to .zprofile if not already there (use grep -qF before appending)
     - Show success message with brew --version

   - Install gum immediately (before returning):
     - `brew install gum` (needed for subsequent UI)
     - If fails: warn but continue (we can fall back to echo)

2. **Update setup**:
   - After calling install-homebrew.sh, re-source ui.sh to pick up gum availability
   - Use proper ui_header for the welcome message IF gum is available
   - Add logic: if `command -v gum`, use Gum; else use plain echo

Error handling per CONTEXT decisions:
- Xcode CLT failure: show error with manual installation instructions
- Homebrew failure: show error, ask to retry or abort (Claude's discretion on exact flow)
- Don't use set -e; check each critical command's exit status
  </action>
  <verify>
    - On a Mac without Xcode CLT: `sh setup` installs Xcode CLT first
    - `xcode-select -p` returns a valid path after installation
    - On a Mac without Homebrew: `sh setup` installs Homebrew and gum
    - On a Mac with Homebrew: `sh setup` skips installation and shows "already installed"
    - After running: `which brew` returns correct path for architecture
    - After running: `grep -q "brew shellenv" ~/.zprofile` confirms shell config updated
    - `sh setup -v` shows verbose output (actual commands, not spinners)
  </verify>
  <done>
    - Xcode Command Line Tools install automatically without manual intervention
    - Homebrew installs successfully on fresh Mac (after Xcode CLT)
    - Architecture-appropriate path is used (/opt/homebrew or /usr/local)
    - PATH is configured for current session and persisted to .zprofile
    - gum is installed immediately after Homebrew
    - Re-running setup skips both Xcode CLT and Homebrew installation (idempotent)
    - Verbose mode shows full command output
  </done>
</task>

</tasks>

<verification>
Run on test Mac (or verify each component):

1. **Structure check:**
   ```bash
   ls -la setup scripts/lib/ config/
   ```

2. **Syntax validation:**
   ```bash
   bash -n setup
   bash -n scripts/lib/ui.sh
   bash -n scripts/lib/detect.sh
   bash -n scripts/install-homebrew.sh
   ```

3. **Help flag:**
   ```bash
   sh setup -h
   ```

4. **Architecture detection:**
   ```bash
   source scripts/lib/detect.sh && echo "ARCH=$ARCH BREW_PREFIX=$BREW_PREFIX"
   ```

5. **Xcode CLT check:**
   ```bash
   xcode-select -p
   ```
   Should return /Library/Developer/CommandLineTools or similar valid path.

6. **Brewfile contains all required tools:**
   ```bash
   grep -E 'brew "(git|node|yarn|pnpm|gh|tree|gum|stow|claude)"' config/Brewfile | wc -l
   # Should return 9 (all required tools)
   ```

7. **Full run (on fresh Mac or with Homebrew uninstalled):**
   ```bash
   sh setup
   which brew
   which gum
   ```
</verification>

<success_criteria>
- [ ] Running `sh setup` on fresh Mac displays welcome message and installs Xcode CLT first
- [ ] Xcode Command Line Tools install automatically without requiring manual dialog interaction
- [ ] Homebrew installs to correct architecture path (after Xcode CLT)
- [ ] gum is installed after Homebrew
- [ ] PATH is configured in current session and .zprofile
- [ ] Re-running `sh setup` skips Xcode CLT and Homebrew (shows "already installed")
- [ ] `sh setup -v` shows verbose output
- [ ] `sh setup -h` shows help
- [ ] All scripts pass bash syntax validation
- [ ] config/Brewfile contains: git, node, yarn, pnpm, gh, tree, gum, stow, claude
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-core-tools/01-01-SUMMARY.md`
</output>
