---
phase: 01-foundation-and-core-tools
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/lib/ui.sh
  - scripts/install-tools.sh
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "UI fallback output shows clean text without -e artifacts when gum is not installed"
    - "install-tools.sh exits gracefully with clear message if Homebrew is not available"
  artifacts:
    - path: "scripts/lib/ui.sh"
      provides: "UI functions with printf-based ANSI output"
      contains: "printf"
    - path: "scripts/install-tools.sh"
      provides: "Defensive check for Homebrew availability"
      contains: "command -v brew"
  key_links:
    - from: "scripts/lib/ui.sh"
      to: "terminal output"
      via: "printf with ANSI codes"
      pattern: 'printf.*\\033'
    - from: "scripts/install-tools.sh"
      to: "brew command"
      via: "defensive availability check"
      pattern: "command -v brew"
---

<objective>
Fix UI fallback artifacts and add defensive Homebrew check

Purpose: Close Gap 2 (echo -e shows "-e" on macOS) and Gap 4 (install-tools.sh fails confusingly when Homebrew not installed)
Output: Clean UI output without artifacts, graceful failure when Homebrew unavailable
</objective>

<execution_context>
@/Users/mlaws/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mlaws/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-core-tools/01-VERIFICATION.md

# Current files to fix
@scripts/lib/ui.sh
@scripts/install-tools.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace echo -e with printf in ui.sh</name>
  <files>scripts/lib/ui.sh</files>
  <action>
Replace all `echo -e` statements with `printf` for ANSI escape code output.

The issue: macOS's built-in echo does not interpret `-e` flag and prints it literally.
The fix: Use `printf` which consistently interprets escape sequences across platforms.

Changes needed in ui.sh fallback sections:

1. ui_header function (around lines 27-31):
   - Change `echo -e "${PINK}...${NC}"` to `printf "${PINK}...${NC}\n"`
   - Apply to all 3 echo -e lines in the fallback block

2. ui_section function (around line 41):
   - Change `echo -e "${BOLD}${PINK}$text${NC}"` to `printf "${BOLD}${PINK}%s${NC}\n" "$text"`

3. ui_success function (around line 51):
   - Change `echo -e "${GREEN}...${NC} $text"` to `printf "${GREEN}...${NC} %s\n" "$text"`

4. ui_error function (around line 61):
   - Change `echo -e "${BOLD}${RED}...${NC} $text"` to `printf "${BOLD}${RED}...${NC} %s\n" "$text"`

5. ui_info function (around line 71):
   - Change `echo -e "${PINK}$text${NC}"` to `printf "${PINK}%s${NC}\n" "$text"`

Important: Use `%s` format specifier for variable text to prevent format string injection.
Keep the plain `echo ""` statements (empty lines) as-is - they don't need printf.
  </action>
  <verify>
Test fallback output without gum:
```bash
# Temporarily hide gum to test fallback
PATH_BACKUP="$PATH"
export PATH=$(echo "$PATH" | tr ':' '\n' | grep -v homebrew | tr '\n' ':')

# Source and test
source scripts/lib/ui.sh
ui_success "Test message"
ui_error "Error test"
ui_info "Info test"

# Restore PATH
export PATH="$PATH_BACKUP"
```
Output should show colored text without any "-e" prefix.
  </verify>
  <done>All ui_* functions produce clean colored output on macOS without gum installed. No "-e" artifacts visible.</done>
</task>

<task type="auto">
  <name>Task 2: Add defensive Homebrew check to install-tools.sh</name>
  <files>scripts/install-tools.sh</files>
  <action>
Add a defensive check at the start of install-tools.sh to exit early with a clear message if Homebrew is not available.

Add after the library sourcing (after line 11), before the section header:

```bash
# Verify Homebrew is available before attempting tool installation
if ! command -v brew >/dev/null 2>&1; then
    echo ""
    ui_error "Homebrew is not installed or not in PATH"
    echo ""
    echo "Please ensure Homebrew installation completed successfully."
    echo "You may need to:"
    echo "  1. Check if /opt/homebrew/bin/brew exists (Apple Silicon)"
    echo "  2. Check if /usr/local/bin/brew exists (Intel)"
    echo "  3. Re-run the setup script"
    echo ""
    exit 1
fi
```

This prevents the confusing "brew: command not found" errors that appear when Homebrew installation failed earlier, giving users clear guidance instead.
  </action>
  <verify>
```bash
# Test by temporarily hiding brew
PATH_BACKUP="$PATH"
export PATH=$(echo "$PATH" | tr ':' '\n' | grep -v homebrew | tr '\n' ':')

# Run install-tools.sh - should exit with clear message
sh scripts/install-tools.sh

# Check exit code
echo "Exit code: $?"

# Restore PATH
export PATH="$PATH_BACKUP"
```
Should see "Homebrew is not installed or not in PATH" error message and exit code 1.
  </verify>
  <done>install-tools.sh exits immediately with helpful error message when Homebrew is not available, instead of failing with confusing "brew: command not found" errors.</done>
</task>

</tasks>

<verification>
1. Run setup on a system without gum installed - UI should show colored output without "-e" artifacts
2. Verify install-tools.sh fails gracefully when brew command not found
3. Verify normal operation still works when both gum and brew are available
</verification>

<success_criteria>
- Gap 2 closed: UI fallback functions use printf, no "-e" artifacts in output
- Gap 4 closed: install-tools.sh checks for Homebrew availability before attempting brew commands
- Existing functionality preserved: scripts work correctly when gum and brew are available
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-core-tools/01-03-SUMMARY.md`
</output>
