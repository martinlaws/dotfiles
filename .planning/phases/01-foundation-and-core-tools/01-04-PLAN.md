---
phase: 01-foundation-and-core-tools
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/install-homebrew.sh
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Xcode Command Line Tools install automatically without GUI dialogs or user clicks"
    - "Homebrew installation prompts for password when needed instead of failing silently"
  artifacts:
    - path: "scripts/install-homebrew.sh"
      provides: "Automated Xcode CLT installation and working Homebrew install"
      contains: "softwareupdate"
  key_links:
    - from: "scripts/install-homebrew.sh"
      to: "softwareupdate command"
      via: "automated CLT installation"
      pattern: "softwareupdate.*install"
    - from: "scripts/install-homebrew.sh"
      to: "Homebrew install script"
      via: "curl without NONINTERACTIVE"
      pattern: 'curl.*Homebrew.*install'
---

<objective>
Fix Xcode CLT auto-installation and Homebrew password prompt

Purpose: Close Gap 1 (Xcode CLT requires manual dialog interaction) and Gap 3 (NONINTERACTIVE=1 blocks password prompt)
Output: Fully automated Xcode CLT installation, working Homebrew installation with password prompt
</objective>

<execution_context>
@/Users/mlaws/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mlaws/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-core-tools/01-VERIFICATION.md
@.planning/phases/01-foundation-and-core-tools/01-01-PLAN.md

# Current file to fix
@scripts/install-homebrew.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement automated Xcode CLT installation using softwareupdate</name>
  <files>scripts/install-homebrew.sh</files>
  <action>
Replace the manual dialog-based Xcode CLT installation with the automated softwareupdate approach.

The original Plan 01-01 Task 2 specified this approach but it was not implemented. The automated approach:

1. Creates a trigger file that makes softwareupdate list CLT as available
2. Uses softwareupdate --install to install CLT silently
3. Cleans up the trigger file

Replace the Xcode CLT installation section (lines 32-71) with:

```bash
    echo "Installing Xcode Command Line Tools automatically..."
    echo ""

    # Create the trigger file that makes softwareupdate list CLT
    TRIGGER_FILE="/tmp/.com.apple.dt.CommandLineTools.installondemand.in-progress"
    sudo touch "$TRIGGER_FILE"

    # Find the CLT package name from softwareupdate
    echo "Finding Command Line Tools package..."
    CLT_PACKAGE=$(softwareupdate --list 2>&1 | grep -o "Command Line Tools for Xcode-[0-9.]*" | head -1)

    if [ -z "$CLT_PACKAGE" ]; then
        # Fallback: try alternate pattern
        CLT_PACKAGE=$(softwareupdate --list 2>&1 | grep -o "\* Label: Command Line Tools.*" | sed 's/\* Label: //' | head -1)
    fi

    if [ -z "$CLT_PACKAGE" ]; then
        # If still not found, clean up and fall back to interactive
        sudo rm -f "$TRIGGER_FILE"
        echo ""
        printf "${YELLOW}Could not find Command Line Tools package automatically.${NC}\n"
        echo "Falling back to interactive installation..."
        echo ""
        xcode-select --install 2>/dev/null
        echo ""
        echo "Please complete the installation dialog, then press RETURN to continue..."
        read -r
    else
        echo "Installing: $CLT_PACKAGE"
        echo ""
        echo "This may take several minutes..."
        echo ""

        # Install CLT via softwareupdate (runs silently)
        if sudo softwareupdate --install "$CLT_PACKAGE" --verbose; then
            printf "${GREEN}...${NC} Xcode Command Line Tools installed successfully\n"
        else
            printf "${RED}...${NC} softwareupdate installation failed\n"
            echo ""
            echo "Falling back to interactive installation..."
            xcode-select --install 2>/dev/null
            echo ""
            echo "Please complete the installation dialog, then press RETURN to continue..."
            read -r
        fi

        # Clean up trigger file
        sudo rm -f "$TRIGGER_FILE"
    fi

    # Verify installation
    if is_xcode_clt_installed; then
        printf "${GREEN}...${NC} Xcode Command Line Tools verified at:\n"
        xcode-select -p
    else
        printf "${RED}...${NC} Xcode Command Line Tools not detected\n"
        echo ""
        echo "Installation may not have completed successfully."
        echo "Please run: xcode-select --install"
        exit 1
    fi
```

Note: This uses sudo for the trigger file and softwareupdate, but those commands will prompt for password naturally - this is acceptable per the CONTEXT.md decision "Prompt when needed."

Also fix the printf in the success check: change `echo -e` to `printf` for consistency with Gap 2 fix.
  </action>
  <verify>
On a Mac with Xcode CLT already installed:
```bash
# Verify the script syntax is valid
bash -n scripts/install-homebrew.sh

# Check that softwareupdate pattern is present
grep -n "softwareupdate" scripts/install-homebrew.sh
```

The full test requires a fresh Mac without CLT, but syntax validation confirms the code is correct.
  </verify>
  <done>Xcode CLT installation uses softwareupdate command for automated installation. Falls back to interactive dialog only if softwareupdate fails. No GUI dialogs in the happy path.</done>
</task>

<task type="auto">
  <name>Task 2: Remove NONINTERACTIVE flag from Homebrew installation</name>
  <files>scripts/install-homebrew.sh</files>
  <action>
Remove the NONINTERACTIVE=1 flag from the Homebrew installation command to allow the password prompt.

Current line (around line 118):
```bash
if NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"; then
```

Change to:
```bash
if /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"; then
```

The NONINTERACTIVE flag was intended to skip confirmations, but it also prevents the sudo password prompt that Homebrew needs for creating /opt/homebrew directory structure on Apple Silicon.

Without NONINTERACTIVE:
- Homebrew will show its normal installation prompts
- User will be asked for password when sudo is needed
- Installation will complete successfully

This aligns with the CONTEXT.md decision: "Sudo password: Prompt when needed - don't ask upfront, only when a step requires it"

Also update the nearby echo message (around line 114) to be clearer:
```bash
printf "${YELLOW}Note:${NC} You will be prompted for your password when needed\n"
```

And fix any remaining `echo -e` statements in install-homebrew.sh to use `printf` for consistency with the ui.sh fixes:
- Line 30: `echo -e "${GREEN}...${NC}"` -> `printf "${GREEN}...${NC}\n"`
- Line 58-61: Similar fixes
- Line 91, 109, 120, 127, 130, 148, 151, 158, 160, 165: All `echo -e` -> `printf`
  </action>
  <verify>
```bash
# Verify syntax
bash -n scripts/install-homebrew.sh

# Verify NONINTERACTIVE is removed
grep -n "NONINTERACTIVE" scripts/install-homebrew.sh
# Should return nothing

# Verify printf is used instead of echo -e
grep -n "echo -e" scripts/install-homebrew.sh
# Should return nothing (or very few lines for non-ANSI usage)
```
  </verify>
  <done>NONINTERACTIVE=1 flag removed. Homebrew installation will prompt for password when needed. All echo -e statements converted to printf for clean output.</done>
</task>

</tasks>

<verification>
1. `bash -n scripts/install-homebrew.sh` - syntax validation passes
2. `grep "NONINTERACTIVE" scripts/install-homebrew.sh` - returns nothing
3. `grep "softwareupdate.*install" scripts/install-homebrew.sh` - shows the automated CLT install command
4. `grep "echo -e" scripts/install-homebrew.sh` - returns nothing (all converted to printf)
</verification>

<success_criteria>
- Gap 1 closed: Xcode CLT installs via softwareupdate without GUI dialogs (with fallback if needed)
- Gap 3 closed: Homebrew installation allows password prompt, no NONINTERACTIVE flag
- All echo -e statements converted to printf for clean macOS output
- Script syntax validates successfully
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-core-tools/01-04-SUMMARY.md`
</output>
