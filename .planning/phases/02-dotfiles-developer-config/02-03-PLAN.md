---
phase: 02-dotfiles-developer-config
plan: 03
type: execute
wave: 3
depends_on: ["02-01", "02-02"]
files_modified:
  - setup
  - scripts/show-report.sh
  - scripts/symlink-dotfiles.sh
  - .gitignore
autonomous: false

must_haves:
  truths:
    - "Running ./setup executes dotfiles symlinking, Git config, and SSH setup"
    - "Completion report shows status of all symlinked configs"
    - "User can verify symlinks work by opening new terminal"
    - "*.local files are gitignored"
    - "Config files are validated before symlinking with user confirmation on issues"
  artifacts:
    - path: "setup"
      provides: "Main entry point calling Phase 2 scripts"
      contains: "symlink-dotfiles.sh"
    - path: "scripts/show-report.sh"
      provides: "Updated completion report with dotfiles status"
      contains: "Dotfiles"
    - path: ".gitignore"
      provides: "Gitignore with *.local pattern"
      contains: "*.local"
    - path: "scripts/symlink-dotfiles.sh"
      provides: "Config validation before symlinking"
      contains: "validate_configs"
  key_links:
    - from: "setup"
      to: "scripts/symlink-dotfiles.sh"
      via: "source command"
      pattern: "source.*symlink-dotfiles"
    - from: "setup"
      to: "scripts/setup-git.sh"
      via: "source command"
      pattern: "source.*setup-git"
    - from: "setup"
      to: "scripts/setup-ssh.sh"
      via: "source command"
      pattern: "source.*setup-ssh"
    - from: "scripts/symlink-dotfiles.sh"
      to: "validation"
      via: "validate_configs function"
      pattern: "validate_configs"
---

<objective>
Integrate Phase 2 scripts into main setup flow, add config validation before symlinking, update completion report, and verify end-to-end functionality.

Purpose: Complete the Phase 2 integration so running ./setup on a fresh Mac delivers fully configured development environment with validated, symlinked dotfiles, personalized Git, and working SSH.
Output: Updated setup entry point, config validation with user prompts, enhanced completion report, human verification of full flow.
</objective>

<execution_context>
@/Users/mlaws/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mlaws/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-dotfiles-developer-config/02-CONTEXT.md

# Prior plans in this phase
@.planning/phases/02-dotfiles-developer-config/02-01-PLAN.md
@.planning/phases/02-dotfiles-developer-config/02-02-PLAN.md

# Files to modify
@setup
@scripts/show-report.sh
@scripts/symlink-dotfiles.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add config validation and integrate Phase 2 scripts into setup</name>
  <files>
    scripts/symlink-dotfiles.sh
    setup
    scripts/show-report.sh
    .gitignore
  </files>
  <action>
1. **Add config validation to symlink-dotfiles.sh** (per user decision in CONTEXT.md):

   Add a validate_configs() function that checks configs before symlinking:

   ```bash
   validate_configs() {
     local issues=()
     local DOTFILES_DIR="$1"

     ui_section "Validating Config Files"

     # Check .zshrc exists and has content
     if [ ! -f "$DOTFILES_DIR/shell/.zshrc" ]; then
       issues+=("shell/.zshrc: File not found")
     elif [ ! -s "$DOTFILES_DIR/shell/.zshrc" ]; then
       issues+=("shell/.zshrc: File is empty")
     fi

     # Check starship.toml is valid TOML (basic check - has format key)
     if [ -f "$DOTFILES_DIR/shell/.config/starship.toml" ]; then
       if ! grep -q "format\|add_newline" "$DOTFILES_DIR/shell/.config/starship.toml"; then
         issues+=("starship.toml: May be invalid (no format or add_newline key)")
       fi
     fi

     # Check .gitconfig.template has required placeholders
     if [ -f "$DOTFILES_DIR/git/.gitconfig.template" ]; then
       if ! grep -q "{{NAME}}" "$DOTFILES_DIR/git/.gitconfig.template"; then
         issues+=(".gitconfig.template: Missing {{NAME}} placeholder")
       fi
       if ! grep -q "{{EMAIL}}" "$DOTFILES_DIR/git/.gitconfig.template"; then
         issues+=(".gitconfig.template: Missing {{EMAIL}} placeholder")
       fi
     else
       issues+=(".gitconfig.template: File not found")
     fi

     # Check SSH config has basic structure
     if [ -f "$DOTFILES_DIR/ssh/.ssh/config" ]; then
       if ! grep -q "Host" "$DOTFILES_DIR/ssh/.ssh/config"; then
         issues+=("ssh/config: No Host entries found")
       fi
     fi

     # Check VS Code settings.json is valid JSON (basic check)
     local vscode_settings="$DOTFILES_DIR/editors/Library/Application Support/Code/User/settings.json"
     if [ -f "$vscode_settings" ]; then
       # Check it starts with { and ends with }
       if ! head -1 "$vscode_settings" | grep -q "^{" || ! tail -1 "$vscode_settings" | grep -q "}$"; then
         issues+=("VS Code settings.json: May be invalid JSON")
       fi
     fi

     # Report results
     if [ ${#issues[@]} -eq 0 ]; then
       ui_success "All config files validated"
       return 0
     else
       ui_error "Found ${#issues[@]} validation issue(s):"
       echo ""
       for issue in "${issues[@]}"; do
         ui_info "  - $issue"
       done
       echo ""

       # User decision point per CONTEXT.md
       if ui_confirm "Continue anyway?"; then
         ui_info "Continuing with symlinking..."
         return 0
       else
         ui_error "Aborting. Fix issues and re-run."
         return 1
       fi
     fi
   }
   ```

   Call validate_configs() BEFORE backup_existing() and stow operations:
   ```bash
   # Validate configs before proceeding
   validate_configs "$DOTFILES_DIR" || return 1
   ```

2. **Update `setup` script** to call Phase 2 scripts after Phase 1:

   After the existing Phase 1 calls (install-homebrew.sh, install-tools.sh), add Phase 2 section:

   ```bash
   # ============================================
   # Phase 2: Dotfiles & Developer Config
   # ============================================

   source "$SCRIPT_DIR/scripts/symlink-dotfiles.sh"
   source "$SCRIPT_DIR/scripts/setup-git.sh"
   source "$SCRIPT_DIR/scripts/setup-ssh.sh"
   ```

   The flow should be:
   - Phase 1: Homebrew, CLI tools
   - Phase 2: Symlink dotfiles (with validation), Git config, SSH setup
   - Show report (already at end)

3. **Update `scripts/show-report.sh`** to include Phase 2 status:

   After the "Installed Tools" section, add a "Dotfiles & Config" section:

   ```bash
   # Dotfiles & Config Status
   ui_section "Dotfiles & Developer Config"
   echo ""

   # Check symlinks
   check_symlink() {
     local target="$1"
     local name="$2"
     if [ -L "$target" ]; then
       ui_success "$name symlinked"
     elif [ -e "$target" ]; then
       ui_info "$name exists (not symlinked)"
     else
       ui_error "$name not found"
     fi
   }

   check_symlink ~/.zshrc "Shell config (.zshrc)"
   check_symlink ~/.config/starship.toml "Starship prompt"
   check_symlink ~/.hyper.js "Hyper terminal"
   check_symlink "$HOME/Library/Application Support/Code/User/settings.json" "VS Code settings"
   check_symlink ~/.ssh/config "SSH config"

   # Check Git config (not symlinked, but should exist)
   if [ -f ~/.gitconfig ]; then
     local git_name=$(git config --global user.name 2>/dev/null || echo "")
     local git_email=$(git config --global user.email 2>/dev/null || echo "")
     if [ -n "$git_name" ]; then
       ui_success "Git configured ($git_name <$git_email>)"
     else
       ui_info "Git config exists but incomplete"
     fi
   else
     ui_error "Git config not found"
   fi

   # Check SSH key
   if [ -f ~/.ssh/id_ed25519 ]; then
     ui_success "SSH key exists"
   else
     ui_info "No SSH key (run setup-ssh.sh to generate)"
   fi

   # Check GitHub connectivity (quick test)
   if ssh -T git@github.com 2>&1 | grep -q "successfully authenticated"; then
     ui_success "GitHub SSH connected"
   else
     ui_info "GitHub SSH not connected (add key to GitHub)"
   fi

   echo ""
   ```

4. **Update "Next Steps" section** in show-report.sh:

   Replace the Phase 1 next steps with Phase 2 completion message:

   ```bash
   ui_section "Next Steps"
   echo ""
   ui_info "1. Open a new terminal to load shell config"
   ui_info "2. If GitHub SSH not connected:"
   ui_info "   cat ~/.ssh/id_ed25519.pub | pbcopy"
   ui_info "   open https://github.com/settings/keys"
   ui_info "3. Ready for Phase 3: Applications & System Settings"
   echo ""
   ```

5. **Create/update `.gitignore`** at repo root to include *.local:

   ```
   # Machine-specific local overrides
   *.local

   # macOS
   .DS_Store

   # Editor
   *.swp
   *~
   ```

   If .gitignore already exists, append the *.local pattern if not present.

IMPORTANT: Keep all existing Phase 1 functionality intact. Phase 2 additions come AFTER Phase 1, BEFORE show-report.
IMPORTANT: validate_configs() must prompt "Continue anyway?" when issues found, per user decision in CONTEXT.md.
  </action>
  <verify>
    - `bash -n scripts/symlink-dotfiles.sh` passes (no syntax errors)
    - `grep "validate_configs" scripts/symlink-dotfiles.sh` shows validation function
    - `grep "Continue anyway" scripts/symlink-dotfiles.sh` shows user prompt on validation issues
    - `bash -n setup` passes (no syntax errors)
    - `grep "symlink-dotfiles" setup` shows Phase 2 integration
    - `grep "setup-git" setup` shows Git config integration
    - `grep "setup-ssh" setup` shows SSH setup integration
    - `grep "Dotfiles" scripts/show-report.sh` shows new section
    - `grep "VS Code" scripts/show-report.sh` shows VS Code symlink check
    - `grep "*.local" .gitignore` shows local files ignored
  </verify>
  <done>
    Config validation added with user prompt on issues. Setup script calls all Phase 2 scripts. show-report.sh displays dotfiles status including VS Code. .gitignore excludes *.local files.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete Phase 2 setup flow</name>
  <what-built>
    Complete dotfiles and developer config setup:
    - Reorganized dotfiles into stow packages (including VS Code at correct macOS path)
    - Config validation before symlinking with "Continue anyway?" prompt
    - Symlink script with backup functionality
    - Git config generation from template
    - SSH key setup with keychain integration
    - GitHub connectivity testing
    - Updated completion report with VS Code status
  </what-built>
  <how-to-verify>
    1. Run the full setup: `./setup`
       - Phase 1 should complete quickly (already installed)
       - Phase 2 should validate configs, symlink dotfiles, configure Git (prompting for name/email if needed), setup SSH

    2. Verify config validation ran:
       - You should see "Validating Config Files" section
       - If issues found, you should have seen "Continue anyway?" prompt

    3. Verify symlinks created:
       - `ls -la ~/.zshrc` should point to repo
       - `ls -la ~/.config/starship.toml` should point to repo
       - `ls -la ~/.hyper.js` should point to repo
       - `ls -la "$HOME/Library/Application Support/Code/User/settings.json"` should point to repo
       - `ls -la ~/.ssh/config` should point to repo

    4. Verify Git config:
       - `cat ~/.gitconfig` should have your name/email
       - `cat ~/.gitconfig | grep "gitconfig.local"` should show .local include

    5. Verify SSH:
       - `ls ~/.ssh/id_ed25519` should exist (or you generated one)
       - `ssh -T git@github.com` should authenticate (if key added to GitHub)

    6. Check completion report shows all status:
       - Dotfiles symlinked section appears
       - VS Code settings status shows
       - Git config status shows
       - SSH key status shows
       - GitHub connectivity status shows

    7. Open a NEW terminal and verify:
       - Starship prompt appears (if terminal is zsh)
       - Git commands work (git status in any repo)
  </how-to-verify>
  <resume-signal>Type "approved" if working correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Full Phase 2 verification:
1. `./setup` runs without errors
2. Config validation runs before symlinking with user prompt on issues
3. All dotfiles are symlinked to home directory (including VS Code)
4. Git is configured with user's name/email
5. SSH key exists (generated or pre-existing)
6. Completion report shows Phase 2 status including VS Code
7. New terminal loads shell config correctly
</verification>

<success_criteria>
- Config files validated before symlinking with "Continue anyway?" prompt on issues
- setup script integrates all Phase 2 scripts in correct order
- Completion report shows symlink status (including VS Code), Git config, SSH key, GitHub connectivity
- *.local files are gitignored
- User confirms end-to-end flow works
- New terminal loads symlinked shell config
</success_criteria>

<output>
After completion, create `.planning/phases/02-dotfiles-developer-config/02-03-SUMMARY.md`
</output>
