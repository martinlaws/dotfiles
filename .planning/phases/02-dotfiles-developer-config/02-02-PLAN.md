---
phase: 02-dotfiles-developer-config
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - scripts/setup-git.sh
  - scripts/setup-ssh.sh
autonomous: true

must_haves:
  truths:
    - "Git config is generated with user's name and email"
    - "SSH keys exist or user is guided to generate them"
    - "SSH connection to GitHub is tested and status shown"
    - "macOS keychain stores SSH key for persistence across reboots"
  artifacts:
    - path: "scripts/setup-git.sh"
      provides: "Git configuration from template with prompting"
      contains: "sed.*NAME.*EMAIL"
    - path: "scripts/setup-ssh.sh"
      provides: "SSH key generation and GitHub connectivity test"
      contains: "ssh-keygen"
  key_links:
    - from: "scripts/setup-git.sh"
      to: "dotfiles/git/.gitconfig.template"
      via: "sed substitution"
      pattern: "gitconfig.template"
    - from: "scripts/setup-ssh.sh"
      to: "github.com"
      via: "ssh -T test"
      pattern: "ssh -T git@github.com"
---

<objective>
Create SSH key setup and Git configuration scripts for developer environment setup.

Purpose: Automate the two most critical developer config steps - SSH keys for secure Git operations and personalized Git configuration. These enable the user to immediately start coding after setup.
Output: setup-ssh.sh (key generation, keychain, GitHub test) and setup-git.sh (template-based config generation)
</objective>

<execution_context>
@/Users/mlaws/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mlaws/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-dotfiles-developer-config/02-CONTEXT.md
@.planning/phases/02-dotfiles-developer-config/02-RESEARCH.md

# Plan 01 creates the template we need
@.planning/phases/02-dotfiles-developer-config/02-01-PLAN.md

# Existing patterns
@scripts/lib/ui.sh
@scripts/install-homebrew.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SSH setup script with key generation and GitHub test</name>
  <files>scripts/setup-ssh.sh</files>
  <action>
Create scripts/setup-ssh.sh that handles SSH key setup:

1. Standard script setup:
   - #!/bin/bash with set -euo pipefail
   - SCRIPT_DIR detection
   - Source ui.sh

2. Main function setup_ssh():

   a. ui_section "SSH Key Setup"

   b. Check for existing Ed25519 key:
      ```bash
      if [ -f ~/.ssh/id_ed25519 ]; then
        ui_success "SSH key already exists (~/.ssh/id_ed25519)"
      else
        # Prompt to generate
        ui_info "No SSH key found"
        if ui_confirm "Generate new Ed25519 SSH key?"; then
          # Get email for key comment
          echo -n "Enter email for SSH key: "
          read -r ssh_email

          # Generate key (let ssh-keygen prompt for passphrase interactively)
          ssh-keygen -t ed25519 -C "$ssh_email" -f ~/.ssh/id_ed25519

          # Add to macOS keychain
          ssh-add --apple-use-keychain ~/.ssh/id_ed25519

          ui_success "SSH key generated and added to keychain"

          # Show public key for copying
          ui_info "Your public key (add to GitHub):"
          echo ""
          cat ~/.ssh/id_ed25519.pub
          echo ""
          ui_info "Copy with: cat ~/.ssh/id_ed25519.pub | pbcopy"
        else
          ui_info "Skipped SSH key generation"
        fi
      fi
      ```

   c. Ensure SSH config exists (should be symlinked from Plan 01, but check):
      ```bash
      if [ ! -f ~/.ssh/config ]; then
        ui_info "Note: SSH config not found. Run symlink-dotfiles.sh first."
      fi
      ```

3. GitHub connectivity test function verify_github_ssh():
   ```bash
   verify_github_ssh() {
     ui_section "GitHub SSH Verification"
     ui_info "Testing connection to GitHub..."

     # ssh -T returns non-zero even on success, so check output
     local result
     result=$(ssh -T git@github.com 2>&1 || true)

     if echo "$result" | grep -q "successfully authenticated"; then
       ui_success "GitHub SSH: Connected"
       return 0
     else
       ui_error "GitHub SSH: Not connected"
       echo ""
       ui_info "To fix:"
       ui_info "  1. Copy your public key: cat ~/.ssh/id_ed25519.pub | pbcopy"
       ui_info "  2. Add to GitHub: https://github.com/settings/keys"
       ui_info "  3. Re-run this script to verify"
       return 1
     fi
   }
   ```

4. Main execution:
   ```bash
   main() {
     setup_ssh
     echo ""
     verify_github_ssh || true  # Don't fail script if GitHub not configured
   }
   main
   ```

IMPORTANT: Use `read -r` for all user input. Let ssh-keygen handle passphrase prompting interactively (do NOT use -N flag).
  </action>
  <verify>
    - `bash -n scripts/setup-ssh.sh` passes (no syntax errors)
    - Script checks for existing key before generating
    - Script uses Ed25519 key type
    - Script adds key to macOS keychain with --apple-use-keychain
    - Script tests GitHub connectivity
  </verify>
  <done>
    setup-ssh.sh handles SSH key detection, generation, keychain integration, and GitHub connectivity testing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Git configuration script with template generation</name>
  <files>scripts/setup-git.sh</files>
  <action>
Create scripts/setup-git.sh that generates ~/.gitconfig from template:

1. Standard script setup:
   - #!/bin/bash with set -euo pipefail
   - SCRIPT_DIR detection
   - Source ui.sh
   - REPO_ROOT detection (parent of scripts/)

2. Main function setup_git():

   a. ui_section "Git Configuration"

   b. Define template path:
      ```bash
      local template="$REPO_ROOT/dotfiles/git/.gitconfig.template"
      local target="$HOME/.gitconfig"
      ```

   c. Check if template exists:
      ```bash
      if [ ! -f "$template" ]; then
        ui_error "Git config template not found: $template"
        ui_info "Run plan 02-01 first to create dotfiles structure"
        return 1
      fi
      ```

   d. Check if ~/.gitconfig already exists with valid user:
      ```bash
      if [ -f "$target" ]; then
        local existing_name existing_email
        existing_name=$(git config --global user.name 2>/dev/null || echo "")
        existing_email=$(git config --global user.email 2>/dev/null || echo "")

        if [ -n "$existing_name" ] && [ -n "$existing_email" ]; then
          ui_success "Git already configured"
          ui_info "  Name: $existing_name"
          ui_info "  Email: $existing_email"

          if ! ui_confirm "Reconfigure Git?"; then
            return 0
          fi
        fi
      fi
      ```

   e. Prompt for user details:
      ```bash
      ui_info "Enter your Git configuration:"
      echo -n "Name: "
      read -r git_name
      echo -n "Email: "
      read -r git_email

      if [ -z "$git_name" ] || [ -z "$git_email" ]; then
        ui_error "Name and email are required"
        return 1
      fi
      ```

   f. Generate config from template:
      ```bash
      # Backup existing if present
      if [ -f "$target" ]; then
        local timestamp=$(date +%Y%m%d_%H%M%S)
        mv "$target" "${target}.backup.${timestamp}"
        ui_info "Backed up existing .gitconfig"
      fi

      # Generate from template using sed
      sed -e "s/{{NAME}}/$git_name/g" -e "s/{{EMAIL}}/$git_email/g" \
        "$template" > "$target"

      # Append .local include at bottom
      echo "" >> "$target"
      echo "[include]" >> "$target"
      echo "  path = ~/.gitconfig.local" >> "$target"

      ui_success "Git configured"
      ui_info "  Name: $git_name"
      ui_info "  Email: $git_email"
      ```

3. Also symlink .gitignore_global:
   ```bash
   setup_gitignore() {
     local source="$REPO_ROOT/dotfiles/git/.gitignore_global"
     local target="$HOME/.gitignore_global"

     if [ -L "$target" ]; then
       ui_success ".gitignore_global already symlinked"
       return 0
     fi

     if [ -e "$target" ]; then
       local timestamp=$(date +%Y%m%d_%H%M%S)
       mv "$target" "${target}.backup.${timestamp}"
       ui_info "Backed up existing .gitignore_global"
     fi

     ln -s "$source" "$target"
     ui_success ".gitignore_global symlinked"
   }
   ```

4. Main execution:
   ```bash
   main() {
     setup_git
     setup_gitignore
   }
   main
   ```

IMPORTANT: Escape any special characters in user input for sed. Use `read -r` for input. The .local include MUST be at the bottom of the file so local settings override.
  </action>
  <verify>
    - `bash -n scripts/setup-git.sh` passes (no syntax errors)
    - Script reads template from dotfiles/git/.gitconfig.template
    - Script prompts for name and email
    - Script uses sed to replace {{NAME}} and {{EMAIL}}
    - Script appends .local include at bottom
    - Script backs up existing config before overwriting
  </verify>
  <done>
    setup-git.sh generates personalized ~/.gitconfig from template, symlinks .gitignore_global, and supports .local overrides.
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `bash -n scripts/setup-ssh.sh` passes
2. `bash -n scripts/setup-git.sh` passes
3. Both scripts source ui.sh
4. setup-ssh.sh uses Ed25519 and tests GitHub
5. setup-git.sh reads template and does sed substitution
</verification>

<success_criteria>
- setup-ssh.sh detects existing keys, generates Ed25519 if missing, adds to keychain, tests GitHub
- setup-git.sh generates ~/.gitconfig from template with user's name/email
- Both scripts follow established patterns (set -euo pipefail, ui.sh, etc.)
- Backup functionality for existing configs
- No syntax errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-dotfiles-developer-config/02-02-SUMMARY.md`
</output>
