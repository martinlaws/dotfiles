---
phase: 02-dotfiles-developer-config
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - dotfiles/shell/.zshrc
  - dotfiles/git/.gitconfig.template
  - dotfiles/git/.gitignore_global
  - dotfiles/terminal/.hyper.js
  - dotfiles/editors/Library/Application Support/Code/User/settings.json
  - dotfiles/shell/.config/starship.toml
  - scripts/symlink-dotfiles.sh
autonomous: true

must_haves:
  truths:
    - "Dotfiles are organized in stow-compatible package structure"
    - "Running stow commands creates correct symlinks to home directory"
    - "Existing config files are backed up before symlinking"
    - "VS Code settings symlink points to ~/Library/Application Support/Code/User/settings.json"
  artifacts:
    - path: "dotfiles/shell/.zshrc"
      provides: "Shell configuration for stow"
    - path: "dotfiles/shell/.config/starship.toml"
      provides: "Starship prompt config in nested structure"
    - path: "dotfiles/git/.gitconfig.template"
      provides: "Git config template with placeholders"
    - path: "dotfiles/terminal/.hyper.js"
      provides: "Terminal config for stow"
    - path: "dotfiles/editors/Library/Application Support/Code/User/settings.json"
      provides: "VS Code settings mirroring home directory path"
    - path: "scripts/symlink-dotfiles.sh"
      provides: "Symlink management with backup and stow"
      contains: "stow -d"
  key_links:
    - from: "scripts/symlink-dotfiles.sh"
      to: "dotfiles/*"
      via: "stow command"
      pattern: "stow -d.*-t.*~"
    - from: "scripts/symlink-dotfiles.sh"
      to: "dotfiles/editors"
      via: "explicit stow editors call"
      pattern: "stow.*editors"
---

<objective>
Reorganize existing dotfiles into GNU Stow package structure and create symlink script with backup functionality.

Purpose: Enable portable, reproducible dotfiles management using industry-standard stow tool. Backup safety ensures no data loss on fresh Mac.
Output: Stow-compatible dotfiles structure and symlink-dotfiles.sh script ready for integration.
</objective>

<execution_context>
@/Users/mlaws/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mlaws/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-dotfiles-developer-config/02-CONTEXT.md
@.planning/phases/02-dotfiles-developer-config/02-RESEARCH.md

# Existing patterns from Phase 1
@scripts/lib/ui.sh
@scripts/install-homebrew.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reorganize dotfiles into Stow package structure</name>
  <files>
    dotfiles/shell/.zshrc
    dotfiles/shell/.config/starship.toml
    dotfiles/git/.gitconfig.template
    dotfiles/git/.gitignore_global
    dotfiles/terminal/.hyper.js
    dotfiles/editors/Library/Application Support/Code/User/settings.json
    dotfiles/ssh/.ssh/config
  </files>
  <action>
Create stow-compatible package structure by reorganizing existing dotfiles:

1. Create dotfiles/ directory with packages: shell, git, terminal, editors, ssh

2. Move/create files into package structure (paths mirror home directory for stow):
   - dotfiles/shell/.zshrc (move from zsh/.zshrc)
   - dotfiles/shell/.config/starship.toml (move from starship/starship.toml, note nested .config path)
   - dotfiles/git/.gitconfig.template (create from git/.gitconfig, replace user.name/email with {{NAME}}/{{EMAIL}} placeholders)
   - dotfiles/git/.gitignore_global (move from git/.gitignore_global)
   - dotfiles/terminal/.hyper.js (move from hyper/.hyper.js)
   - dotfiles/editors/Library/Application Support/Code/User/settings.json (move from vscode/Library/Application Support/Code/User/settings.json)
     NOTE: macOS path uses "Library/Application Support" NOT ".config" - this mirrors ~/Library/Application Support/Code/User/settings.json
   - dotfiles/ssh/.ssh/config (create new with keychain settings for GitHub)

3. Update .zshrc to include .local override at bottom:
   Add: `[ -f ~/.zshrc.local ] && source ~/.zshrc.local`

4. Create dotfiles/ssh/.ssh/config with generic SSH config:
   ```
   Host *
     AddKeysToAgent yes
     UseKeychain yes
     IdentityFile ~/.ssh/id_ed25519

   Host github.com
     HostName github.com
     User git
     IdentityFile ~/.ssh/id_ed25519

   Include ~/.ssh/config.local
   ```

5. Delete old directories after moving: zsh/, git/, hyper/, starship/, vscode/, vim/ (keep vim/.vimrc - move to dotfiles/shell/.vimrc or skip if not wanted)

6. Add *.local to .gitignore at repo root (create if needed)

IMPORTANT: The .gitconfig.template should have {{NAME}} and {{EMAIL}} placeholders where user.name and user.email values currently are. Keep ALL other settings intact.
IMPORTANT: VS Code path is "Library/Application Support" (macOS convention), NOT ".config" (Linux convention).
  </action>
  <verify>
    - `ls -la dotfiles/` shows shell, git, terminal, editors, ssh directories
    - `cat dotfiles/git/.gitconfig.template | grep "{{NAME}}"` shows placeholder
    - `cat dotfiles/shell/.zshrc | grep "zshrc.local"` shows .local sourcing
    - `ls "dotfiles/editors/Library/Application Support/Code/User/settings.json"` confirms VS Code path exists
    - Old directories (zsh/, git/, hyper/, starship/, vscode/) are removed
  </verify>
  <done>
    Dotfiles reorganized into stow-compatible packages with .gitconfig converted to template, .local override patterns added, and VS Code settings at correct macOS path.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create symlink script with backup and stow</name>
  <files>scripts/symlink-dotfiles.sh</files>
  <action>
Create scripts/symlink-dotfiles.sh that:

1. Sources ui.sh for consistent styling

2. Implements backup_existing() function:
   ```bash
   backup_existing() {
     local target="$1"
     if [ -e "$target" ] || [ -L "$target" ]; then
       local timestamp=$(date +%Y%m%d_%H%M%S)
       local backup="${target}.backup.${timestamp}"
       mv "$target" "$backup"
       ui_info "Backed up: $(basename "$target") -> $(basename "$backup")"
     fi
   }
   ```

3. Main symlink flow:
   - ui_header "Symlinking Dotfiles"
   - Check that stow is installed (error and exit if not)
   - Define DOTFILES_DIR as repo's dotfiles/ directory
   - Backup existing files before stowing:
     - ~/.zshrc
     - ~/.config/starship.toml (create ~/.config if needed)
     - ~/.hyper.js
     - ~/Library/Application Support/Code/User/settings.json (create parent dirs if needed)
     - ~/.ssh/config (create ~/.ssh if needed with 700 permissions)
   - Run stow for each package explicitly:
     ```bash
     # Stow shell package
     stow -d "$DOTFILES_DIR" -t ~ shell
     ui_success "Symlinked shell configs"

     # Stow terminal package
     stow -d "$DOTFILES_DIR" -t ~ terminal
     ui_success "Symlinked terminal configs"

     # Stow editors package (VS Code/Cursor settings)
     stow -d "$DOTFILES_DIR" -t ~ editors
     ui_success "Symlinked editor configs"
     ```
   - Handle ssh separately with directory permissions:
     ```bash
     mkdir -p ~/.ssh && chmod 700 ~/.ssh
     stow -d "$DOTFILES_DIR" -t ~ ssh
     ui_success "Symlinked SSH config"
     ```
   - Do NOT stow git package (handled separately via template generation)
   - Return 0 on success

4. Follow existing script patterns from install-homebrew.sh:
   - set -euo pipefail
   - SCRIPT_DIR detection
   - Source ui.sh
   - Proper error handling

IMPORTANT: Do NOT symlink .gitconfig - it will be generated from template by setup-git.sh (Plan 02-02).
IMPORTANT: The editors package stow creates symlink at ~/Library/Application Support/Code/User/settings.json (macOS path).
  </action>
  <verify>
    - `bash -n scripts/symlink-dotfiles.sh` passes (no syntax errors)
    - Script sources ui.sh correctly
    - `grep "stow.*editors" scripts/symlink-dotfiles.sh` shows explicit editors package stow
    - Script uses stow with correct -d and -t flags for shell, terminal, editors, ssh
    - Script backs up existing files before stowing
    - `grep "Library/Application Support" scripts/symlink-dotfiles.sh` shows VS Code backup path
  </verify>
  <done>
    symlink-dotfiles.sh created with backup functionality and explicit stow commands for shell, terminal, editors (VS Code), and ssh packages. Git package excluded (uses template).
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `ls dotfiles/` shows: shell, git, terminal, editors, ssh
2. `cat dotfiles/git/.gitconfig.template` contains {{NAME}} and {{EMAIL}} placeholders
3. `cat dotfiles/shell/.zshrc` includes .zshrc.local sourcing
4. `cat dotfiles/ssh/.ssh/config` contains keychain and GitHub settings
5. `ls "dotfiles/editors/Library/Application Support/Code/User/settings.json"` confirms VS Code path
6. `bash -n scripts/symlink-dotfiles.sh` passes syntax check
7. `grep "stow.*editors" scripts/symlink-dotfiles.sh` confirms editors package explicitly stowed
8. Old dotfile directories removed
</verification>

<success_criteria>
- Dotfiles reorganized into 5 stow packages (shell, git, terminal, editors, ssh)
- VS Code settings at correct macOS path: dotfiles/editors/Library/Application Support/Code/User/settings.json
- .gitconfig converted to template with placeholders
- .local override pattern added to shell config
- Generic SSH config created with keychain integration
- symlink-dotfiles.sh explicitly stows shell, terminal, editors, ssh packages
- symlink-dotfiles.sh backs up existing files including VS Code settings
- Git package excluded from stow (uses template generation)
- No syntax errors in scripts
</success_criteria>

<output>
After completion, create `.planning/phases/02-dotfiles-developer-config/02-01-SUMMARY.md`
</output>
