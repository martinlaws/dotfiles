#!/bin/bash
#
# Dotfiles Setup - Entry Point
# Run with: sh setup

# Exit on any error, undefined variable, or pipe failure
set -euo pipefail

# Parse command-line flags
VERBOSE=false

show_help() {
    cat << EOF
Usage: sh setup [-v] [-h]

Flags:
  -v  Verbose mode (show full command output)
  -h  Show this help message

EOF
    exit 0
}

while getopts "vh" opt; do
    case $opt in
        v) VERBOSE=true ;;
        h) show_help ;;
        *)
            echo "Invalid option. Use -h for help."
            exit 1
            ;;
    esac
done

# Get script directory and detect architecture
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
export SCRIPT_DIR

# Source detection library
# shellcheck source=scripts/lib/detect.sh
. "$SCRIPT_DIR/scripts/lib/detect.sh"

# Source state library (for update mode detection)
# shellcheck source=scripts/lib/state.sh
. "$SCRIPT_DIR/scripts/lib/state.sh"

# Export verbose flag for child scripts
export VERBOSE

# Check for existing setup (update mode detection)
if state_exists; then
  # Update mode - state file exists from previous run
  export UPDATE_MODE=true

  # Need gum for update mode UI
  if ! command -v gum >/dev/null 2>&1; then
    echo "Error: gum required for update mode but not found"
    echo "Please run a fresh setup first"
    exit 1
  fi

  # Source UI library
  . "$SCRIPT_DIR/scripts/lib/ui.sh"

  # Run update flow
  source "$SCRIPT_DIR/scripts/run-updates.sh"

  # Show completion report (in update mode)
  source "$SCRIPT_DIR/scripts/show-report.sh"

  exit 0
fi

# First-time setup continues below...
export UPDATE_MODE=false

# Display welcome message (plain echo for now, will use Gum after Homebrew installed)
echo ""
echo "================================================"
echo "  Dotfiles Setup"
echo "================================================"
echo ""
echo "Detected architecture: $ARCH"
echo "Homebrew will install to: $BREW_PREFIX"
echo ""

# Install Homebrew and Xcode CLT
sh "$SCRIPT_DIR/scripts/install-homebrew.sh"

# After Homebrew is installed, gum is available
# Source UI library to use Gum functions
if command -v gum >/dev/null 2>&1; then
    # shellcheck source=scripts/lib/ui.sh
    . "$SCRIPT_DIR/scripts/lib/ui.sh"
fi

# Install CLI tools from Brewfile
sh "$SCRIPT_DIR/scripts/install-tools.sh"

# ============================================
# Phase 2: Dotfiles & Developer Config
# ============================================

source "$SCRIPT_DIR/scripts/symlink-dotfiles.sh"
source "$SCRIPT_DIR/scripts/setup-git.sh"
source "$SCRIPT_DIR/scripts/setup-ssh.sh"

# ============================================
# Phase 3: Applications & System Settings
# ============================================

source "$SCRIPT_DIR/scripts/configure-system.sh"
source "$SCRIPT_DIR/scripts/install-apps.sh"

# Initialize state tracking for future update mode
state_init
state_set_last_run
state_save_packages  # Save initial package list
state_set_phase_complete "01-foundation"
state_set_phase_complete "02-dotfiles"
state_set_phase_complete "03-applications"

# Show completion report
sh "$SCRIPT_DIR/scripts/show-report.sh"
